"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},__assign.apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,t,r){if(r||2===arguments.length)for(var i,a=0,n=t.length;a<n;a++)!i&&a in t||(i||(i=Array.prototype.slice.call(t,0,a)),i[a]=t[a]);return e.concat(i||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModelComponent=void 0;var jsx_runtime_1=require("react/jsx-runtime"),api_1=require("api"),code_types_1=require("code-types"),fancy_loader_1=require("fancy-loader"),fs_util_js_1=require("fs-util-js"),js_util_1=require("js-util"),labeled_button_1=require("labeled-button"),markdown_1=require("markdown"),react_with_native_1=require("react-with-native"),react_with_native_alert_1=require("react-with-native-alert"),react_with_native_router_1=require("react-with-native-router"),react_with_native_select_1=require("react-with-native-select"),store_1=require("../store"),CrudGrid_1=require("./CrudGrid"),CrudTable_1=require("./CrudTable"),CrudTimeline_1=require("./CrudTimeline"),CrudTree_1=require("./CrudTree"),useInfiniteGetDbModel_1=require("./useInfiniteGetDbModel"),DatasetForm_1=require("./DatasetForm"),SearchBar_1=require("./SearchBar"),deleteDbModel=api_1.api.deleteDbModel,ModelComponent=function(e){var t,r,i=e.modelName,a=e.highlight,n=(0,react_with_native_alert_1.useAlert)(),l=(0,react_with_native_router_1.useRouter)(),o=code_types_1.modelViews.map((function(e){return{value:e.view,label:"".concat(e.emoji," ").concat(e.view)}})),_=(0,react_with_native_select_1.useSelect)(o,o[0]),s=_[0],u=_[1].value,d=api_1.queries.useGetDbModelMetadata(i),c=(0,js_util_1.destructureOptionalObject)(null===(t=d.data)||void 0===t?void 0:t.result),v=c.datasets,h=c.tsInterface,m=null==v?void 0:v.map((function(e){return{label:e.name,value:e.id,data:e}})),p=__spreadArray(__spreadArray([{value:"",label:"Select a dataset"}],m||[],!0),[{value:"new",label:"(+) New dataset"}],!1),j=(0,react_with_native_select_1.useSelect)(p,void 0,(function(e){"new"!==(null==e?void 0:e.value)?""!==(null==e?void 0:e.value)?(null==e?void 0:e.data)&&g(__assign(__assign({},e.data),{key:"config".concat(Math.random())})):g(null):
// show a blank screen
g({key:"config".concat(Math.random())})}))[0],f=(0,store_1.useStore)("db-crud.datasetConfig"),x=f[0],g=f[1],b=(0,useInfiniteGetDbModel_1.useInfiniteGetDbModel)(),w=api_1.queries.useGetReferencableModelData(i),y=b.isLoading||b.isRefetching||b.isFetching,C=null===(r=null==b?void 0:b.data)||void 0===r?void 0:r.pages.map((function(e){var t;return null===(t=e.result)||void 0===t?void 0:t.data})).flat().filter(js_util_1.notEmpty),q=h?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[(0,jsx_runtime_1.jsx)(react_with_native_1.P,__assign({className:"font-bold"},{children:h.name})),(0,markdown_1.renderMarkdownContent)(h.description||"No description",{projectRelativeBaseFolderPath:(0,fs_util_js_1.getFolderJs)(h.projectRelativePath),projectRelativeMarkdownFilePath:h.projectRelativePath})]}):y?(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{}):"No index found",D=(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row items-center"},{children:[(0,jsx_runtime_1.jsx)(labeled_button_1.LabeledButton,{onClick:function(){return l.push("/upsert/".concat(i))},title:"New",emoji:"➕"}),(0,jsx_runtime_1.jsx)(labeled_button_1.LabeledButton,__assign({},{onClick:function(){return b.refetch()},title:"Reload",emoji:y?void 0:"🔄",component:y?function(){return(0,jsx_runtime_1.jsx)(fancy_loader_1.FancyLoader,{medium:!0})}:void 0})),(0,jsx_runtime_1.jsx)(s,{}),(0,jsx_runtime_1.jsx)(j,{}),(0,jsx_runtime_1.jsx)(SearchBar_1.SearchBar,{})]})),M=[{action:function(e){null==n||n("Are you sure?","Do you want to delete this one?",[{text:"Yes",style:"destructive",onPress:function(){(null==e?void 0:e.id)&&
// console.log({ id: item.id });
deleteDbModel(i,e.id).then((function(e){b.refetch(),w.refetch()}))}},{text:"Cancel",style:"cancel"}])},emoji:"❌",name:"Delete"},{name:"Update",emoji:"✏️",action:function(e){return l.push("/upsert/".concat(i,"?id=").concat(null==e?void 0:e.id))}}],T={table:CrudTable_1.CrudTable,grid:CrudGrid_1.CrudGrid,timeline:CrudTimeline_1.CrudTimeline,tree:CrudTree_1.CrudTree}[u],N={actions:M,data:C,highlight:a,tsInterface:h,onEndReached:function(){var e,t,r=null===(e=b.data)||void 0===e?void 0:e.pages,i=r?r[r.length-1]:void 0;(null===(t=null==i?void 0:i.result)||void 0===t?void 0:t.hasMore)&&!b.isFetchingNextPage&&b.fetchNextPage()}};return(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"px-8 lg:px-20 py-4"},{children:[D,q,x&&i?(0,jsx_runtime_1.jsx)(DatasetForm_1.DatasetForm,{modelName:i},x.key):null]})),Array.isArray(C)&&C.length>0&&T?(0,jsx_runtime_1.jsx)(T,__assign({},N)):null]})};exports.ModelComponent=ModelComponent;
//# sourceMappingURL=ModelComponent.js.map