"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,a){function i(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,o,r,a,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,o=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){i.label=a[1];break}if(6===a[0]&&i.label<r[1]){i.label=r[1],r=a;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(a);break}r[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.rebuildOperation=void 0;
// node wrappers
var run_child_process_1=require("run-child-process"),log_1=require("log"),set_json_key_1=require("set-json-key"),get_package_json_1=require("get-package-json"),cleanup_typescript_database_1=require("cleanup-typescript-database"),database_1=require("database"),generate_index_1=require("generate-index"),js_util_1=require("js-util"),operation_util_1=require("operation-util"),markdown_parsings_1=require("markdown-parsings"),one_by_one_1=require("one-by-one"),get_package_source_paths_1=require("get-package-source-paths"),lint_1=require("lint"),get_path_1=require("get-path"),fs_util_1=require("fs-util"),filename_conventions_1=require("filename-conventions"),shouldSkip_1=require("./shouldSkip"),isOperationBuildNeeded_1=require("./isOperationBuildNeeded"),yarnBuild_1=require("./yarnBuild"),exitIfProcessDependenciesChange_1=require("./exitIfProcessDependenciesChange"),executeCommandQuietUnlessFail_1=require("./executeCommandQuietUnlessFail"),isSdkOperation_1=require("./isSdkOperation"),generateJsonSchemas_1=require("./generateJsonSchemas"),rebuildOperation=function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,n,o,r,a,i,s,l,u,c,p,d,_,g,m,f,b,y,h,P,k,v,x,j,w,O,R,q;return __generator(this,(function(N){switch(N.label){case 0:return t=e.operationBasePath,n=e.force,o=e.debug,r=e.noExit,a=e.stack,i=void 0===a?[]:a,s=e.updatedAt,l=e.noUnresolvedRebuilding,u=e.operationManualProjectRoot,c=e.typerepoManualProjectRoot,p=e.filePaths,d=(0,fs_util_1.getLastFolder)(t),[4/*yield*/,(0,get_package_json_1.getPackageJson)({operationFolderPath:t})];case 1:return _=N.sent(),(0,isSdkOperation_1.isSdkOperation)(t)||(0,filename_conventions_1.isGeneratedOperation)(t)?(console.log("not going to rebuild sdk operation: ".concat(d)),[2/*return*/,!1]):(g="".concat(i.map((function(){return"--"})).join("")).concat(d,": "),(0,log_1.log)("".concat(g,"Rebuilding").concat(i.length>0?"(coming from ".concat(i.join(", "),")"):""),{type:"important"}),(0,log_1.log)("".concat(g,"Pre-index lint"),{type:"important"}),[4/*yield*/,(0,lint_1.preIndexLint)({operationFolderPath:t})]);case 2:return(m=N.sent()).length>0?((0,log_1.log)("".concat(g,"Operation cannot be built, we've got problem(s)"),{type:"warning"}),(0,log_1.log)(m.join("\n"),{type:"warning"}),[4/*yield*/,database_1.db.update("Operation",(function(){return!0}),(function(e){return(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.lintProblems",m,e),e}),{operationName:d})]):[3/*break*/,4];case 3:return N.sent(),[2/*return*/,!1];case 4:return[4/*yield*/,(0,shouldSkip_1.shouldSkip)({operationBasePath:t,debug:o,force:n,rebuildUpdatedAt:s,operationManualProjectRoot:u})];case 5:return N.sent()?((0,log_1.log)("Skipping ".concat(d)),[2/*return*/,!0]):[4/*yield*/,(0,cleanup_typescript_database_1.cleanupTsDatabase)(d,u)];case 6:return f=N.sent(),(0,log_1.log)((null==f?void 0:f.amountRemoved)?"Removed ".concat(null==f?void 0:f.amountRemoved," ts db instances"):"Nothing to clean up",{type:"success"}),(0,executeCommandQuietUnlessFail_1.executeCommandQuietUnlessFail)({command:"yarn --offline",cwd:t,description:"".concat(g,"Installing")}),
// 2a) finding imports/exports and writing them to index
// TODO: we can also just check if build folder and index.js exist before looking at the import statements. These are easy to detect and when that happens we don't need to do the things below.
(0,log_1.log)("".concat(g,"Getting imports/exports"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"get-imports-exports",scriptFileName:"findAndWriteImportsExports.cli",args:[t,u]})];case 7:return N.sent(),"sdk"===d?[3/*break*/,15]:[4/*yield*/,database_1.db.get("TsImport",{operationName:d,manualProjectRoot:u})];case 8:return x=N.sent(),(b=x.filter((function(e){return e.isAbsolute&&e.isModuleFromMonorepo&&!e.isModuleResolved})).map((function(e){return e.module})).filter(js_util_1.onlyUnique)).length>0?l?((0,log_1.log)("rebuilding the unresolved modules didn't work. Probably some indexation fails!",{type:"error"}),[4/*yield*/,database_1.db.update("Operation",(function(){return!0}),(function(e){return(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.dependencyBuildFailed",!0,e),e}),{operationName:d,manualProjectRoot:u})]):[3/*break*/,10]:[3/*break*/,14];case 9:return N.sent(),[2/*return*/,!1];case 10:return(0,log_1.log)("".concat(g,"We need to rebuild ").concat(b.length," operations because they have conflicts (").concat(b.join(", "),")"),{type:"warning"}),[4/*yield*/,(0,one_by_one_1.oneByOne)(b,(function(e){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4/*yield*/,(0,get_path_1.getOperationPath)(e,{manualProjectRoot:u})];case 1:return n.sent()?e===d||i.includes(e)?((0,log_1.log)("".concat(g,"cyclic dep"),{type:"warning"}),[2/*return*/,!1]):(console.log("".concat(g,"diving into new rebuildOperation "),{operationName:d,stack:i,unresolvedOperationName:e}),[2/*return*/,(0,exports.rebuildOperation)({operationManualProjectRoot:u,typerepoManualProjectRoot:c,operationBasePath:t,stack:i.concat([e]),debug:o,
// can't skip this one because it is a dependency
// however, skipping is very well defined. we can skip if shouldSkip is true!
// force: true,
noExit:r})]):((0,log_1.log)("".concat(g).concat(e," not found"),{type:"warning"}),[2/*return*/,!1])}}))}))}))];case 11:return y=N.sent(),(0,js_util_1.isAllTrue)(y)?[3/*break*/,13]:((0,log_1.log)("".concat(g,"something failed! returning")),[4/*yield*/,database_1.db.update("Operation",(function(){return!0}),(function(e){return(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.dependenciesBuildsFailed",!0,e),e}),{operationName:d,manualProjectRoot:u})]);case 12:return N.sent(),[2/*return*/,!1];case 13:
// NB: all files on purpose...
return(0,log_1.log)("".concat(g,"rebuilding ourselves again")),[2/*return*/,(0,exports.rebuildOperation)({operationManualProjectRoot:u,typerepoManualProjectRoot:c,operationBasePath:t,debug:o,force:n,noExit:r,noUnresolvedRebuilding:!0,stack:i.concat([d])})];case 14:(0,log_1.log)("".concat(g,"all imports were resolved")),N.label=15;case 15:
// 2b) compiling and writing build errors to index
return(0,log_1.log)("".concat(g,"writing build errors SKIPPED due to memory bug"),{type:"important"}),p?[3/*break*/,18]:(P=(h=Promise).all,[4/*yield*/,(0,get_package_source_paths_1.getPackageSourcePaths)({operationBasePath:t,ignoreIndexFiles:!0})]);case 16:return[4/*yield*/,P.apply(h,[N.sent()])];case 17:
//files from src
p=N.sent().filter(js_util_1.notEmpty),N.label=18;case 18:
// first index the files that have changed
return 0===p.length?(0,log_1.log)("".concat(g,"No files found for operation ").concat(d),{type:"error"}):(0,log_1.log)("".concat(g).concat(p.length," files to index:"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"index-typescript",scriptFileName:"cli",args:__spreadArray(__spreadArray([],p,!0),[u||"null"],!1)})];case 19:
// first index the files that have changed
return N.sent(),[4/*yield*/,(0,generate_index_1.generateSimpleIndex)({operationName:d,manualProjectRoot:u})];case 20:return N.sent(),k=(0,isOperationBuildNeeded_1.isOperationBuildNeeded)(t),!0,k?(v=null===(q=null==_?void 0:_.operation)||void 0===q?void 0:q.skipMinify,[4/*yield*/,(0,yarnBuild_1.yarnBuild)(t,{rmFirst:!1,skipMinify:v})]):[3/*break*/,24];case 21:return N.sent(),[4/*yield*/,database_1.db.get("TsImport",{manualProjectRoot:u})];case 22:return x=N.sent(),j=x.filter((function(e){return e.isModuleFromMonorepo&&e.module===d})).map((function(e){return e.operationName})).filter(js_util_1.onlyUnique).filter(js_util_1.notEmpty),w=__spreadArray([d],j,!0),O=w.map((function(e){
// NB: we need this to be a child process because it requires the tests from the index, and that file changes, while normally a require will be cached. We can't easily invalidate the cache because it can come from many files.
return(0,run_child_process_1.runChildProcess)({operationFolderName:"k-test",scriptFileName:"runTestsForOperation.cli",args:[e,u]})})),[4/*yield*/,Promise.all(O)];case 23:N.sent(),N.label=24;case 24:return[4/*yield*/,(0,generateJsonSchemas_1.generateJsonSchemas)(u,d)];case 25:return N.sent(),[4/*yield*/,database_1.db.update("Operation",(function(){return!0}),(function(e){return(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.buildSucceeded",!0,e),e}),{operationName:d,manualProjectRoot:u})];case 26:return N.sent(),[4/*yield*/,(0,markdown_parsings_1.getOperationSummary)({operationName:d,manualProjectRoot:u})];case 27:return(R=N.sent())?[4/*yield*/,(0,markdown_parsings_1.operationToMarkdown)({operationSummary:R,returnType:"save"})]:[3/*break*/,29];
// make a readme of the new index
case 28:
// make a readme of the new index
N.sent(),N.label=29;case 29:return[4/*yield*/,database_1.db.update("Operation",(function(){return!0}),(function(e){return(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.indexImportExportError","",e),(0,set_json_key_1.setKeyAtLocation)("operation.buildResultIndexed.lintProblems",m,e),e}),{operationName:d,manualProjectRoot:u})];case 30:return N.sent(),[4/*yield*/,(0,operation_util_1.recalculateOperationIndexJson)(t,u)];case 31:return N.sent(),r?[3/*break*/,33]:[4/*yield*/,(0,exitIfProcessDependenciesChange_1.exitIfProcessDependenciesChanged)(d,u)];case 32:N.sent(),N.label=33;case 33:return[2/*return*/,!0]}}))}))};
// monorepo
exports.rebuildOperation=rebuildOperation;
//# sourceMappingURL=rebuildOperation.js.map