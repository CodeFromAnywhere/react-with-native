"use strict";var __awaiter=this&&this.__awaiter||function(e,r,n,t){return new(n||(n=Promise))((function(a,s){function i(e){try{u(t.next(e))}catch(e){s(e)}}function o(e){try{u(t.throw(e))}catch(e){s(e)}}function u(e){var r;e.done?a(e.value):(r=e.value,r instanceof n?r:new n((function(e){e(r)}))).then(i,o)}u((t=t.apply(e,r||[])).next())}))},__generator=this&&this.__generator||function(e,r){var n,t,a,s,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,t&&(a=2&s[0]?t.return:s[0]?t.throw||((a=t.return)&&a.call(t),0):t.next)&&!(a=a.call(t,s[1])).done)return a;switch(t=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,t=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=r.call(e,i)}catch(e){s=[6,e],t=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.driverSignup=void 0;var database_1=require("database"),model_types_1=require("model-types"),server_login_1=require("server-login"),driverSignup=function(e){return __awaiter(void 0,void 0,void 0,(function(){var r,n,t,a,s,i,o,u,l,c,f,p;return __generator(this,(function(d){switch(d.label){case 0:return r=(0,model_types_1.generateRandomString)(32),n=e.email,t=e.name,a=e.phone,s=e.password,i=e.repeatPassword,!t||t.length<3?[2/*return*/,{isSuccesful:!1,message:"Please enter a name (at least 3 characters)"}]:n||a?a&&a.length<10?[2/*return*/,{isSuccesful:!1,message:"Please enter a correct phone number"}]:n&&!(0,model_types_1.isEmail)(n)?[2/*return*/,{isSuccesful:!1,message:"Please enter a correct email"}]:s!==i?[2/*return*/,{isSuccesful:!1,message:"Those passwords do not match"}]:s&&(0,server_login_1.isValidPassword)(s)?[4/*yield*/,(0,server_login_1.encryptPassword)(s)]:[2/*return*/,{isSuccesful:!1,message:"Please provide a safer password (min. 6 characters)"}]:[2/*return*/,{isSuccesful:!1,message:"Please enter a phone or email"}];case 1:return o=d.sent(),[4/*yield*/,database_1.db.get("JeepType")];case 2:return u=d.sent(),l=u.find((function(e){return e.email===n})),!n||!l?(c=u.find((function(e){return e.phone===a})),!a||!c?(f={phone:a,name:t,email:n,note:"",amountLuggageUnitsLeft:0,amountSeatsLeft:0,isVerified:!1,loginToken:r,encrypedPassword:o},void 0,[4/*yield*/,database_1.db.upsert("JeepType",f,undefined)]):[2/*return*/,{isSuccesful:!1,message:"There is already a driver with that phone number. Please try logging in, or sign up with a different phone or email."}]):[2/*return*/,{isSuccesful:!1,message:"There is already a driver with that email. Please try logging in, or sign up with a different phone or email."}];case 3:return!1===(p=d.sent()).isSuccesful?(console.log({upsertResult:p}),[2/*return*/,{isSuccesful:!1,message:"Something went wrong"}]):[2/*return*/,{isSuccesful:!0,message:"You have succesfully registered. Your account now needs to be verified before your jeep will appear on the app. Please hang on and drive safely."}]}}))}))};exports.driverSignup=driverSignup;
//# sourceMappingURL=driverSignup.js.map