"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function a(e){try{l(o.next(e))}catch(e){s(e)}}function i(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,i)}l((o=o.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,o,n,s,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,o&&(n=2&s[0]?o.return:s[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,s[1])).done)return n;switch(o=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,o=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(n=a.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){a.label=s[1];break}if(6===s[0]&&a.label<n[1]){a.label=n[1],n=s;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(s);break}n[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],o=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.processAsset=void 0;var fs_util_1=require("fs-util"),get_path_1=require("get-path"),convert_case_1=require("convert-case"),getStorageLocationInfo_1=require("./getStorageLocationInfo"),getTemporaryAssetsFolderPath_1=require("./getTemporaryAssetsFolderPath"),log_1=require("log"),js_util_1=require("js-util"),processAsset=function(
/**
 * The backendAsset that may need processing
 */
e){return __awaiter(void 0,void 0,void 0,(function(){var t,r,o,n,s,a,i,l,c,u,p,_,f,g,h,d,v;return __generator(this,(function(y){switch(y.label){case 0:return(t=(0,get_path_1.getProjectRoot)())&&(r=e?(0,js_util_1.takeFirst)(e):void 0)?(o=r.alt,n=r.name,s=r.relativePath,a=r.temporaryDestination,i=r.projectRelativeReferencingFilePath,l=r.modelName,i?(c=fs_util_1.path.join(t,i),u=(0,convert_case_1.slugify)(n&&n.length>0?n:"untitled"),s||a?
// NB: If a `temporaryDestination` is given, if it doesn't exist, we return nothing, this is an invalid input.
(p=a?fs_util_1.path.join((0,getTemporaryAssetsFolderPath_1.getTemporaryAssetsFolderPath)(),a):void 0)&&!fs_util_1.fs.existsSync(p)?((0,log_1.log)("processAsset: absoluteTemporaryDestination does not exist",{type:"warning"}),[2/*return*/,void 0]):
// NB: if a relativePath is provided without a temporaryDestination, it means the file should already be there. If it's not there, we return nothing, invalid input.
!(_=s?fs_util_1.path.join(fs_util_1.path.parse(c).dir,s):void 0)||a||fs_util_1.fs.existsSync(_)?(f=a?a.split(".").pop():null==s?void 0:s.split(".").pop())?(g=(0,getStorageLocationInfo_1.getStorageLocationInfo)(c,l),h=fs_util_1.path.join(g.absoluteAssetBaseFolderPath,"".concat(u,".").concat(f)),d=h,p?(d=(0,fs_util_1.getFirstAvailableFilename)(h),[4/*yield*/,(0,fs_util_1.renameAndCreate)(p,d)]):[3/*break*/,2]):((0,log_1.log)("processAsset: could not create extension",{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: oldAssetStoragePath does not exist (".concat(_,")"),{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: no relativePath, no temporaryDestination",{type:"warning"}),[2/*return*/,void 0])):((0,log_1.log)("processAsset: projectRelativeReferencingFilePath wasn't provided, not processing asset",{type:"warning"}),[2/*return*/,void 0])):[2/*return*/];case 1:return y.sent(),[3/*break*/,4];case 2:return _?_===h?[3/*break*/,4]:(d=(0,fs_util_1.getFirstAvailableFilename)(h),[4/*yield*/,(0,fs_util_1.renameAndCreate)(_,d)]):[3/*break*/,4];case 3:
// the name has changed
y.sent(),y.label=4;case 4:
//({ newRelativePath });
return v=(0,get_path_1.getRelativeLinkPath)(c,d),[2/*return*/,{alt:o,relativePath:v}]}}))}))};exports.processAsset=processAsset;
//# sourceMappingURL=processAsset.js.map