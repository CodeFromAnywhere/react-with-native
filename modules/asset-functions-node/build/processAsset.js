"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(s,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function i(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var o,r,s,n,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function i(n){return function(i){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(s=a.trys,(s=s.length>0&&s[s.length-1])||6!==n[0]&&2!==n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=t.call(e,a)}catch(e){n=[6,e],r=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,i])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.processAsset=void 0;var fs_util_1=require("fs-util"),get_path_1=require("get-path"),convert_case_1=require("convert-case"),getStorageLocationInfo_1=require("./getStorageLocationInfo"),getTemporaryAssetsFolderPath_1=require("./getTemporaryAssetsFolderPath"),log_1=require("log"),js_util_1=require("js-util"),processAsset=function(
/**
 * The backendAsset that may need processing
 */
e){return __awaiter(void 0,void 0,void 0,(function(){var t,o,r,s,n,a,i,l,c,u,p,_,f,g,h,d,v;return __generator(this,(function(y){switch(y.label){case 0:return(t=(0,get_path_1.getProjectRoot)())?(o=e?(0,js_util_1.takeFirst)(e):void 0)?(r=o.alt,s=o.name,n=o.relativePath,a=o.temporaryDestination,i=o.projectRelativeReferencingFilePath,l=o.modelName,i?(c=fs_util_1.path.join(t,i),u=(0,convert_case_1.slugify)(s&&s.length>0?s:"untitled"),n||a?
// NB: If a `temporaryDestination` is given, if it doesn't exist, we return nothing, this is an invalid input.
(p=a?fs_util_1.path.join((0,getTemporaryAssetsFolderPath_1.getTemporaryAssetsFolderPath)(),a):void 0)&&!fs_util_1.fs.existsSync(p)?((0,log_1.log)("processAsset: absoluteTemporaryDestination does not exist",{type:"warning"}),[2/*return*/,void 0]):
// NB: if a relativePath is provided without a temporaryDestination, it means the file should already be there. If it's not there, we return nothing, invalid input.
!(_=n?fs_util_1.path.join(fs_util_1.path.parse(c).dir,n):void 0)||a||fs_util_1.fs.existsSync(_)?(f=a?a.split(".").pop():null==n?void 0:n.split(".").pop())?(g=(0,getStorageLocationInfo_1.getStorageLocationInfo)(c,l),h=fs_util_1.path.join(g.absoluteAssetBaseFolderPath,"".concat(u,".").concat(f)),d=h,p?(d=(0,fs_util_1.getFirstAvailableFilename)(h),[4/*yield*/,(0,fs_util_1.renameAndCreate)(p,d)]):[3/*break*/,2]):((0,log_1.log)("processAsset: could not create extension",{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: oldAssetStoragePath does not exist (".concat(_,")"),{type:"warning"}),[2/*return*/,void 0]):((0,log_1.log)("processAsset: no relativePath, no temporaryDestination",{type:"warning"}),[2/*return*/,void 0])):((0,log_1.log)("processAsset: projectRelativeReferencingFilePath wasn't provided, not processing asset",{type:"warning"}),[2/*return*/,void 0])):(console.log("processAsset: No real backend asset"),[2/*return*/]):(console.log("processAsset: No project root"),[2/*return*/]);case 1:return y.sent(),[3/*break*/,4];case 2:return _?_===h?[3/*break*/,4]:(d=(0,fs_util_1.getFirstAvailableFilename)(h),[4/*yield*/,(0,fs_util_1.renameAndCreate)(_,d)]):[3/*break*/,4];case 3:
// the name has changed
y.sent(),y.label=4;case 4:return v=(0,get_path_1.getRelativeLinkPath)(c,d),
//({ newRelativePath });
console.log({alt:r,relativePath:n}),[2/*return*/,{alt:r,relativePath:v}]}}))}))};exports.processAsset=processAsset;
//# sourceMappingURL=processAsset.js.map