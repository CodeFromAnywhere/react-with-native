"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{u(r.next(e))}catch(e){a(e)}}function s(e){try{u(r.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sdkWriteToFile=exports.onlyNodeAndJsOperations=exports.noSpecialExports=exports.exportHasNoSdkDependants=exports.getSdkOutputPath=void 0;var db_1=require("db"),fs_util_1=require("fs-util"),get_path_1=require("get-path"),js_util_1=require("js-util"),log_1=require("log"),one_by_one_1=require("one-by-one"),generateIndex_1=require("./generateIndex"),find_all_dependency_operations_1=require("find-all-dependency-operations"),getSdkOutputPath=function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,n,r;return __generator(this,(function(o){switch(o.label){case 0:return t=null==e?void 0:e.saveInAssets,n=null==e?void 0:e.manualProjectRoot,[4/*yield*/,(0,get_path_1.getOperationPath)("sdk",{manualProjectRoot:n})];case 1:return r=o.sent(),[2/*return*/,t?fs_util_1.path.join(__dirname,"..","assets","sdk.ts"):r&&fs_util_1.path.join(r,"src","sdk.ts")]}}))}))};exports.getSdkOutputPath=getSdkOutputPath;
/**
 * don't add the exports from the sdk and packages dependent on sdk, because that would create circular dependencies
 *
 * also, sdk-ui seems to give some strange warning (SyntaxError: Cannot use import statement outside a module)... maybe because it points directly to the typescript instead of the build? for now we can hardcode remove it, but it's best to check the package.json: does main lead to src or build? ts or js? */
var exportHasNoSdkDependants=function(e,t){return!e.operationName||!t.includes(e.operationName)};exports.exportHasNoSdkDependants=exportHasNoSdkDependants;
/**
 * 1) don't do default exports, because they are discouraged and should also be named
 * 2) don't do sdk exports because they are a special type that is generated here
 */
var noSpecialExports=function(e){return!["default","sdk"].includes(e.name)};exports.noSpecialExports=noSpecialExports;
/**
 * es-6 ui cannot be in the sdk because it leads directly to typescript files, untranspiled, unbuilt. We can't have that.
 */
var onlyNodeAndJsOperations=function(e,t){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(n){return e.operationName?[2/*return*/,"js"===t||"node"===t]:[2/*return*/,!1]}))}))};exports.onlyNodeAndJsOperations=onlyNodeAndJsOperations;
/**
 * generates sdk for all operations
 *
 * TODO: this should be ran every time a file is saved, but it should be fast enough for that..
 *
 * TODO: BUG: sdk-endpoints zat in sdk weer en ook de ding dependent daarop... hoezo?
 *
remove react stuff

Make this function in a way that it doesn't block anything. It could remove the old sdks after the new ones are created (in different folder name). This way the sdk generation script can run automatically in the background, so you don't need to think about it. Ensure that it doesn't have duplicate names though when installing! `package.json` should be template until finish

Also think about how the performance of this can be improved. There are probably many ways.
 */
var sdkWriteToFile=function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,n,r,o,a,i,s,u,l;return __generator(this,(function(p){switch(p.label){case 0:return t=null==e?void 0:e.manualProjectRoot,(n=t||(0,get_path_1.getProjectRoot)())?[4/*yield*/,(0,exports.getSdkOutputPath)(e)]:[2/*return*/];case 1:return(r=p.sent())?[4/*yield*/,(0,find_all_dependency_operations_1.findDependantsRecursively)("sdk")]:[2/*return*/,(0,log_1.log)("Outputpath not found",{type:"error"})];case 2:return o=p.sent(),[4/*yield*/,db_1.db.get("TsExport",{operationIndexFiles:"index.json",manualProjectRoot:t})];case 3:return a=p.sent().map((function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,r;return __generator(this,(function(o){switch(o.label){case 0:return e.operationName?[4/*yield*/,(0,get_path_1.getOperationPath)(e.operationName,{manualProjectRoot:n})]:[2/*return*/];case 1:return(t=o.sent())&&(r=(0,get_path_1.getOperationClassification)(t))?[2/*return*/,{tsExport:e,operationClassification:r}]:[2/*return*/]}}))}))})),[4/*yield*/,Promise.all(a)];case 4:return i=p.sent().filter(js_util_1.notEmpty),s=i.filter((function(e){var t=e.tsExport,n=e.operationClassification;return(0,exports.onlyNodeAndJsOperations)(t,n)})).map((function(e){return e.tsExport})).filter(exports.noSpecialExports).filter((function(e){return(0,exports.exportHasNoSdkDependants)(e,o)})),[4/*yield*/,(0,one_by_one_1.oneByOne)(s,(function(e){return __awaiter(void 0,void 0,void 0,(function(){var n,r,o;return __generator(this,(function(a){switch(a.label){case 0:return e.operationName?[4/*yield*/,(0,get_path_1.getOperationPath)(e.operationName,{manualProjectRoot:t})]:[2/*return*/,null];case 1:return(n=a.sent())?(r=fs_util_1.path.join(n,"build"),o=fs_util_1.path.join(n,"build","index.js"),fs_util_1.fs.existsSync(r)&&fs_util_1.fs.existsSync(o)?[2/*return*/,e]:[2/*return*/,null]):[2/*return*/,null]}}))}))}))];case 5:return u=p.sent().filter(js_util_1.notEmpty),[4/*yield*/,db_1.db.get("TsFunction",{manualProjectRoot:t})];case 6:return l=p.sent(),console.log({allResolvableExports:u.length,allIndexExports:i.length}),[4/*yield*/,(0,generateIndex_1.generateIndex)({exportArray:u,functionArray:l,operationName:"sdk",isSdk:!0,outputPath:r,exportGroupedTypes:!0,exportGroupedTypesName:"Sdk",exportSdk:!0,exportSeparate:!1})];case 7:return p.sent(),[2/*return*/]}}))}))};exports.sdkWriteToFile=sdkWriteToFile;
//# sourceMappingURL=sdkWriteToFile.js.map