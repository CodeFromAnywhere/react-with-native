"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,a){function o(e){try{s(i.next(e))}catch(e){a(e)}}function l(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,l)}s((i=i.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,i,r,a,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,i=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){o.label=a[1];break}if(6===a[0]&&o.label<r[1]){o.label=r[1],r=a;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(a);break}r[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],i=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var i,r=0,a=t.length;r<a;r++)!i&&r in t||(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AssetInput=void 0;var jsx_runtime_1=require("react/jsx-runtime"),react_with_native_store_1=require("react-with-native-store"),react_1=require("react"),react_with_native_1=require("react-with-native"),clickable_icon_1=require("clickable-icon"),api_1=require("api"),server_api_url_1=require("server-api-url"),js_util_1=require("js-util"),asset_view_1=require("asset-view"),react_with_native_alert_1=require("react-with-native-alert"),asset_functions_js_1=require("asset-functions-js"),MediaRecorder_1=require("./MediaRecorder"),Webcam_1=require("./Webcam"),SelectMedia_1=require("./select-media/SelectMedia"),FileInput_1=require("./FileInput"),makeBackendAsset_1=require("./util/makeBackendAsset"),model_types_1=require("model-types"),AssetInput=function(e){var t=e.attachTokenToFilename,n=e.defaultAssetName,i=e.onChange,r=(e.allowMultiple,e.value),a=e.inputTypes,o=e.projectRelativeReferencingFilePath,l=e.modelName,s=(0,react_1.useState)((0,model_types_1.generateRandomString)(32))[0],c=(0,asset_functions_js_1.ensureToken)(n,s,t),u=(0,react_with_native_alert_1.useAlert)(),_=a&&1===a.length?a[0]:null,d=(0,react_1.useState)(_),p=d[0],m=d[1],f=(0,react_1.useState)([]),v=f[0],b=f[1],h=(0,react_1.useState)(r||[]),j=h[0],x=h[1],g=(0,react_1.useState)(c),k=g[0],y=g[1];
/**
     * generate a random token for this component, once, only if it loads...
     */(0,react_1.useEffect)((function(){var e=j.map((function(e){return e.name===k?__assign(__assign({},e),{name:c}):e}));x(e),y(c)}),[c]);
/**
     * Removes asset from selectedBlobs, external value, and at the server
     */
var w=function(e,t){return __awaiter(void 0,void 0,void 0,(function(){var n,a,l,s;return __generator(this,(function(c){switch(c.label){case 0:return n=(0,js_util_1.removeIndexFromArray)(j,t),x(n),a=(0,js_util_1.removeIndexFromArray)(r||[],t),i(a),e.relativePath?[4/*yield*/,api_1.api.deleteReferencedAsset(o,e.relativePath)]:[3/*break*/,2];case 1:l=c.sent().result,s=null==l?void 0:l.isSuccessful,null==u||u(s?"Deleted":"Something went wrong",null==l?void 0:l.message),c.label=2;case 2:return[2/*return*/]}}))}))},S=function(e,t){return __awaiter(void 0,void 0,void 0,(function(){var n,i,r,a,o;return __generator(this,(function(l){switch(l.label){case 0:return e.blob&&e.blobPath?[4/*yield*/,(0,react_with_native_store_1.getItem)(api_1.AUTH_TOKEN_STORAGE_KEY)]:(console.log("Please provide a blob and blobPath to send the blob"),[2/*return*/]);case 1:return n=l.sent(),i=(null==t?void 0:t.authToken)||n,r=(null==t?void 0:t.apiUrl)||server_api_url_1.apiUrl,a="".concat(r,"/function/uploadAssetWithContext"),o=new XMLHttpRequest,[4/*yield*/,new Promise((function(t,n){o.upload.addEventListener("abort",(function(){console.log("XHR Upload Abort"),n({isSuccessful:!1})})),o.upload.addEventListener("error",(function(){console.log("XHR Upload Error"),n({isSuccessful:!1})})),o.upload.addEventListener("timeout",(function(){console.log("XHR Upload Timeout"),n({isSuccessful:!1})})),o.upload.addEventListener("progress",(function(t){if(t.lengthComputable){var n=t.loaded/t.total;
// console.log("upload progress:", uploadProgress);
i=e.blobPath,r=__assign(__assign({},e),{uploadProgress:n}),x((function(e){return e.map((function(e){return e.blobPath===i?r:e}))}))}var i,r})),o.addEventListener("progress",(function(e){if(e.lengthComputable)e.loaded,e.total;
// console.log("download progress:", downloadProgress);
// TODO: set this to a state
})),o.addEventListener("loadend",(function(e){var n=4===o.readyState&&200===o.status,i=o.response?JSON.parse(o.response):void 0;t({isSuccessful:n,response:i})})),o.addEventListener("timeout",(function(e){console.log("XHR Timeout"),n({isSuccessful:!1})})),o.addEventListener("error",(function(e){console.log("XHR Error"),n({isSuccessful:!1})})),o.addEventListener("abort",(function(e){console.log("XHR Aborted"),n({isSuccessful:!1})})),o.open("POST",a,!0);var r=new FormData;r.append("file",e.blob),i&&
// NB: we need to adhere the `api` convention!
r.append("authToken",i),o.send(r)}))];case 2:
// NB: now, call onchange
// console.log("success:", xhrResult);
return[2/*return*/,l.sent().response]}}))}))};
/**
     * Local update!
     */return(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[null===p||_?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[null===p?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row"},{children:[!a||a.includes("recordAudio")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ”ˆ",onClick:function(){return m("recordAudio")}}):null,!a||a.includes("recordVideo")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸŽ¥",onClick:function(){return m("recordVideo")}}):null,!a||a.includes("recordScreen")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ’»",onClick:function(){return m("recordScreen")}}):null,!a||a.includes("camera")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ“¸",onClick:function(){return m("camera")}}):null,!a||a.includes("files")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ“‚",onClick:function(){return m("files")}}):null,!a||a.includes("project-media")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ‘‘",onClick:function(){return m("project-media")}}):null,!a||a.includes("p2p-media")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ‘¥",onClick:function(){return m("p2p-media")}}):null,!a||a.includes("youtube")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"â¯",onClick:function(){return m("youtube")}}):null,!a||a.includes("google-images")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ”Ž",onClick:function(){return m("google-images")}}):null,!a||a.includes("giphy")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸ¦„",onClick:function(){return m("giphy")}}):null,!a||a.includes("unsplashed")?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"ðŸŒ…",onClick:function(){return m("unsplashed")}}):null]})):null,null==j?void 0:j.map((function(e,n){return(0,jsx_runtime_1.jsx)(asset_view_1.InteractiveAsset,{attachTokenToFilename:t,projectRelativeReferencingFilePath:o,asset:e,remove:function(){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(t){return[2/*return*/,w(e,n)]}))}))},onChange:function(t){var a=j.map((function(i,r){return r===n?t:e}));x(a);var s=r?r.map((function(e){var n=e.relativePath||e.temporaryDestination,i=t.relativePath||t.temporaryDestination;return void 0!==n&&void 0!==i&&n===i?(0,makeBackendAsset_1.makeBackendAsset)(t,o,l):e})):void 0;s&&i(s)}},"asset".concat(n))}))]}):null,null!==p||_?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row justify-between"},{children:[_?(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{}):(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"âŒ",onClick:function(){b([]),_||m(null)}}),v.length>0?(0,jsx_runtime_1.jsx)(clickable_icon_1.ClickableIcon,{emoji:"âœ…",onClick:function(){__awaiter(void 0,void 0,void 0,(function(){var e,t,n;return __generator(this,(function(a){switch(a.label){case 0:return 0===v.length?[2/*return*/]:(x(__spreadArray(__spreadArray([],j,!0),v,!0)),b([]),[4/*yield*/,Promise.all(v.map((function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,n,i,r;return __generator(this,(function(a){switch(a.label){case 0:return[4/*yield*/,S(e)];case 1:return(t=a.sent())?(n=__assign(__assign({},e),{temporaryDestination:null===(r=t.result)||void 0===r?void 0:r.temporaryDestination}),i=(0,makeBackendAsset_1.makeBackendAsset)(n,o,l),[2/*return*/,{newSelectedBlob:n,newBackendAsset:i}]):[2/*return*/]}}))}))})))]);case 1:return e=a.sent().filter(js_util_1.notEmpty),t=e.map((function(e){return e.newBackendAsset})),n=e.map((function(e){return e.newSelectedBlob})),x(n),i(r?__spreadArray(__spreadArray([],r,!0),t,!0):t),[2/*return*/]}}))})),b([]),_||m(null)}}):(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{})]})):null,(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:["files"===p?(0,jsx_runtime_1.jsx)(FileInput_1.FileInput,{setBlobs:function(e){b(e)}}):null,"camera"===p?(0,jsx_runtime_1.jsx)(Webcam_1.WebcamCapture,{withBlob:function(e,t){return b([{blobPath:e,type:"image",blob:t,name:c,sizeBytes:t.size,uploadProgress:0}])}}):null,"recordAudio"===p?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"audio",withBlob:function(e,t){return b([{blobPath:e,type:"audio",blob:t,name:c,uploadProgress:0,sizeBytes:t.size}])}}):null,"recordVideo"===p?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"video",withBlob:function(e,t){return b([{blobPath:e,type:"video",blob:t,name:c,sizeBytes:t.size,uploadProgress:0}])}}):null,"recordScreen"===p?(0,jsx_runtime_1.jsx)(MediaRecorder_1.MediaRecorder,{type:"screen",withBlob:function(e,t){return b([{blobPath:e,type:"video",blob:t,name:c,sizeBytes:t.size,uploadProgress:0}])}}):null,"project-media"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"project"}):null,"p2p-media"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"p2p"}):null,"google-images"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"google"}):null,"giphy"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"giphy"}):null,"unsplashed"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"unsplashed"}):null,"youtube"===p?(0,jsx_runtime_1.jsx)(SelectMedia_1.SelectMedia,{source:"youtube"}):null]})]})};exports.AssetInput=AssetInput;
//# sourceMappingURL=AssetInput.js.map